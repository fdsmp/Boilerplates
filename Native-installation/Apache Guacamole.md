# Installing Guacamole natively on Debian 11

## Introduction

Apache Guacamole is a free and open-source, cross-platform, clientless remote desktop gateway maintained by the Apache Software Foundation. It enables users to control remote computers or virtual machines through a web browser, while allowing administrators to determine how and if users can connect using a flexible authentication and authorization system. Destination machines can be kept isolated behind Guacamole and do not need to be accessible over the internet.

Remote access is facilitated through the guacd component, which utilizes RDP, VNC, or SSH remote protocols to access resources. Guacamole is clientless and does not require the installation of an agent on the accessed resources. The web-based client feature enables users to connect to their remote desktops without the need for a remote desktop client installation.

[Source](https://guacamole.apache.org/doc/gug/installing-guacamole.html) 

Guacamole is separated into two pieces: guacamole-server, which provides the guacd proxy and related libraries, and guacamole-client, which provides the client to be served by your servlet container, usually Tomcat.

## Building guacamole-server

### Install the required dependencies

```shell
apt-get update
apt-get install build-essential libcairo2-dev libjpeg62-turbo-dev libpng-dev libtool-bin uuid-dev libossp-uuid-dev libavcodec-dev libavformat-dev libavutil-dev libswscale-dev freerdp2-dev libpango1.0-dev libssh2-1-dev libtelnet-dev libvncserver-dev libwebsockets-dev libpulse-dev libssl-dev libvorbis-dev libwebp-dev
```

### Obtaining the source code

You can obtain a copy of the guacamole-server source from the Guacamole project web [site](https://downloads.apache.org/guacamole/).

> If you want the absolute latest code, and don’t care that the code hasn’t been as rigorously tested as the code in stable releases, you can also clone the Guacamole team’s git repository on GitHub

```
cd /tmp
```
  
Once the download is complete, extract the `tar.gz` archive and navigate to the resulting directory:

```shell
tar -xzf guacamole-server-1.5.3.tar.gz
cd guacamole-server-1.5.3/
```
### The build process

Run the configure script generated by GNU Autotools. It assesses available libraries on your system and selects the necessary components for building based on your installed dependencies.

```shell
./configure --with-init-dir=/etc/init.d
```

```
checking for a BSD-compatible install... /usr/bin/install -c
checking whether build environment is sane... yes
...

------------------------------------------------
guacamole-server version 1.5.3
------------------------------------------------

   Library status:

     freerdp2 ............ yes
     pango ............... yes
     libavcodec .......... yes
     libavformat ......... yes
     libavutil ........... yes
     libssh2 ............. yes
     libssl .............. yes
     libswscale .......... yes
     libtelnet ........... yes
     libVNCServer ........ yes
     libvorbis ........... yes
     libpulse ............ yes
     libwebsockets ....... yes
     libwebp ............. yes
     wsock32 ............. no

   Protocol support:

      Kubernetes .... yes
      RDP ........... yes
      SSH ........... yes
      Telnet ........ yes
      VNC ........... yes

   Services / tools:

      guacd ...... yes
      guacenc .... yes
      guaclog .... yes

   Init scripts: /etc/init.d
   Systemd units: no

Type "make" to compile guacamole-server.
```

Compile the source code and install guacamole-server :

```shell
make
```
### Installation

Install the components that were built :

```shell
make install
```

```
Making install in src/libguac
make[1]: Entering directory `/home/mjumper/guacamole/guacamole-server/src/libguac'
make[2]: Entering directory `/home/mjumper/guacamole/guacamole-server/src/libguac'
...
----------------------------------------------------------------------
Libraries have been installed in:
   /usr/local/lib

If you ever happen to want to link against installed libraries
in a given directory, LIBDIR, you must either use libtool, and
specify the full pathname of the library, or use the `-LLIBDIR'
flag during linking and do at least one of the following:
   - add LIBDIR to the `LD_LIBRARY_PATH' environment variable
     during execution
   - add LIBDIR to the `LD_RUN_PATH' environment variable
     during linking
   - use the `-Wl,-rpath -Wl,LIBDIR' linker flag
   - have your system administrator add LIBDIR to `/etc/ld.so.conf'

See any operating system documentation about shared libraries for
more information, such as the ld(1) and ld.so(8) manual pages.
----------------------------------------------------------------------
make[2]: Nothing to be done for `install-data-am'.
make[2]: Leaving directory `/home/mjumper/guacamole/guacamole-server/src/protocols/vnc'
make[1]: Leaving directory `/home/mjumper/guacamole/guacamole-server/src/protocols/vnc'
make[1]: Entering directory `/home/mjumper/guacamole/guacamole-server'
make[2]: Entering directory `/home/mjumper/guacamole/guacamole-server'
make[2]: Nothing to be done for `install-exec-am'.
make[2]: Nothing to be done for `install-data-am'.
make[2]: Leaving directory `/home/mjumper/guacamole/guacamole-server'
make[1]: Leaving directory `/home/mjumper/guacamole/guacamole-server'
```

Update your system’s cache of installed libraries :

```shell
ldconfig
```

Reload the systemd daemon to ensure it picks up any changes made to unit files :

```shell
systemctl daemon-reload
```

Start the guacd service, which is the Guacamole proxy daemon:  

```shell
systemctl start guacd
```

Enable the guacd service to start automatically on system boot :

```shell
systemctl enable guacd
```

Check the Guacamole server status :

```shell
systemctl status guacd
```

```shell
● guacd.service - LSB: Guacamole proxy daemon
     Loaded: loaded (/etc/init.d/guacd; generated)
     Active: active (running) since Wed 2024-05-08 12:31:11 CEST; 15s ago
       Docs: man:systemd-sysv-generator(8)
      Tasks: 1 (limit: 4642)
     Memory: 10.0M
        CPU: 60ms
     CGroup: /system.slice/guacd.service
             └─20538 /usr/local/sbin/guacd -p /var/run/guacd.pid

mai 08 12:31:11 debian systemd[1]: Starting guacd.service - LSB: Guacamole proxy daemon...
mai 08 12:31:11 debian guacd[20536]: Guacamole proxy daemon (guacd) version 1.5.5 started
mai 08 12:31:11 debian guacd[20535]: Starting guacd:
mai 08 12:31:11 debian guacd[20536]: guacd[20536]: INFO:        Guacamole proxy daemon (guacd) version 1.5.5 started
mai 08 12:31:11 debian guacd[20535]: SUCCESS
mai 08 12:31:11 debian systemd[1]: Started guacd.service - LSB: Guacamole proxy daemon.
mai 08 12:31:11 debian guacd[20538]: Listening on host ::1, port 4822
```

Create the Guacamole configuration directory :

```shell
mkdir -p /etc/guacamole/{extensions,lib}
```

## Installing the guacamole-client as a Web App

Install tomca9 :

```shell
apt-get install tomcat9 tomcat9-admin tomcat9-common tomcat9-user
```
### install the guacamole-client

Download the guacamole-client Tomcat web application binary file into the webapps directory :

```shell
cd /var/lib/tomcat9/webapps
wget https://downloads.apache.org/guacamole/1.5.3/binary/guacamole-1.5.3.war
```

Restart guacamole and tomcat :

```shell
systemctl restart guacd tomcat9
```

## Installing MariaDB 

The MariaDB (or MySQL) database in a Guacamole stack stores configurations, user authentication information, activity logs, and manages user sessions, thereby contributing to the smooth operation of the application.

```shell
apt-get install mariadb-server
```

Secure your MariaDB instance:

```shell
mysql_secure_installation
```

Connect to your MariaDB instance using the root account :

```shell
mysql -u root -p
```

Create a database and a dedicated user for Apache Guacamole. The commands below create the "guacadb" database, with the "guaca_nachos" user associated with the password "P@ssword!" (adapt these values). This user has some rights on the database.

```sql
CREATE DATABASE guacadb;
CREATE USER 'guaca_nachos'@'localhost' IDENTIFIED BY 'P@ssword!';
GRANT SELECT,INSERT,UPDATE,DELETE ON guacadb.* TO 'guaca_nachos'@'localhost';
FLUSH PRIVILEGES;
EXIT;
```

Installation of the MySQL extension :

```shell
cd /tmp
wget https://downloads.apache.org/guacamole/1.5.5/binary/guacamole-auth-jdbc-1.5.3.tar.gz
```

```shell
tar -xzf guacamole-auth-jdbc-1.5.3.tar.gz
mv guacamole-auth-jdbc-1.5.3 /etc/guacamole/extensions
```

Download and install JDBC (Java Database Connectivity) connector for MySQLl [here](https://dev.mysql.com/downloads/connector/j/)

```shell
https://downloads.mysql.com/archives/get/p/3/file/mysql-connector-j-8.0.33.tar.gz
```

```shell
tar -xzf mysql-connector-j-8.0.33.tar.gz
```

```shell
cp mysql-connector-j-8.0.33/mysql-connector-j-8.0.33.jar /etc/guacamole/lib/
```

Use the scripts in the folder `guacamole-auth-jdbc-1.5.3/mysql/schema/` to create the database structure as well as the user "guacadmin".

```shell
cd guacamole-auth-jdbc-1.5.3/mysql/schema/
```

```shell
cat *.sql | mysql -u root -p guacadb
```

Create and edit the `guacamole.properties` file to declare the connection to MariaDB. This file can be used for other settings as per your requirements :

```shell
nano /etc/guacamole/guacamole.properties
```

```
# MySQL
mysql-hostname: 127.0.0.1
mysql-port: 3306
mysql-database: guacadb
mysql-username: guaca_nachos
mysql-password: P@ssword!
```

Create and edit the `guacd.conf` file to configure the Guacamole server :

```shell
nano /etc/guacamole/guacd.conf
```

```
[server] 
bind_host = 0.0.0.0
bind_port = 4822
```

Restart the services :

```
systemctl restart tomcat9 guacd mariadb
```

## Access your Guacamole instance Web interface

```
http://localhost:8080/guacamole
```

> - user: **guacadmin**
> - password : **guacadmin**

Configure the firewall on your server to only allow necessary network traffic. Do not expose the Guacamole web interface directly. Use a reverse proxy and SSL to secure communications.
## SSH Connexion issue

If the SSH connection fails, it appears to be related to the cryptographic backend used during the compilation of the libssh component.
You must compile the libssh library using an OpenSSL cryptographic backend.

Back up the existing libs :

```shell
cd ~/
cp /usr/lib/x86_64-linux-gnu/libssh2.so .
```

Clone the repo, create folders

```
apt-get install -y git libssh-dev cmake
git clone https://github.com/libssh2/libssh2.git
cd libssh2
mkdir bin
cd bin
```

Recompile the libs

```
cmake -DCRYPTO_BACKEND=OpenSSL ..
cmake --build .
cp src/libssh2.so* /usr/lib/x86_64-linux-gnu
```